<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAW Insight - ä¸“ä¸šåŸå§‹å½±åƒè§£æå·¥å…·</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --border: #2a3854;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .container { 
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto;
        }
        .card { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header {
            margin-bottom: 25px;
        }
        h1 { 
            font-size: 24px; 
            font-weight: 700; 
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        .subtitle { 
            color: var(--text-secondary); 
            font-size: 14px; 
            line-height: 1.5;
        }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed var(--border); 
            border-radius: 16px; 
            padding: 40px 20px;
            text-align: center; 
            cursor: pointer; 
            background: rgba(42, 56, 84, 0.3);
            margin-bottom: 20px;
        }
        .upload-area:hover, .upload-area.dragover { 
            border-color: var(--accent); 
            background: rgba(56, 189, 248, 0.05);
        }
        .upload-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--accent);
        }
        .upload-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        .upload-hint {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        input[type="file"] { display: none; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading { 
            display: none; 
            text-align: center; 
            padding: 15px 0;
        }
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* EXIFé¢æ¿ */
        .exif-panel { 
            display: none; 
            margin: 20px 0;
            background: var(--bg-tertiary);
            border-radius: 16px;
            padding: 20px;
        }
        .exif-section {
            margin-bottom: 15px;
        }
        .exif-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent);
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }
        .exif-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .exif-item { font-size: 13px; }
        .exif-label { 
            color: var(--text-tertiary); 
            display: block; 
            font-size: 11px; 
            text-transform: uppercase; 
            margin-bottom: 2px;
        }
        .exif-value { font-weight: 600; }

        /* é¢„è§ˆé¢æ¿ */
        .preview-panel { 
            display: none; 
            margin-top: 20px;
        }
        .preview-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .preview-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .preview-img-container {
            background: var(--bg-primary);
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            position: relative;
        }
        .preview-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            object-fit: contain;
            background: #000;
        }
        .preview-loading {
            position: absolute;
            color: var(--text-tertiary);
            font-size: 12px;
        }
        .preview-error {
            color: var(--error);
            font-size: 12px;
            text-align: center;
            padding: 20px;
        }
        .preview-format-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--warning);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0.8;
        }
        .preview-info {
            padding: 12px;
        }
        .preview-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .preview-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .preview-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { 
            background: var(--accent); 
            color: white; 
            text-decoration: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 13px; 
            font-weight: 600;
            border: none; 
            cursor: pointer; 
            flex: 1;
            min-width: 100px;
            text-align: center;
        }
        .btn:hover { 
            background: var(--accent-hover);
        }
        .btn-secondary { 
            background: var(--bg-primary); 
            border: 1px solid var(--border); 
            color: var(--text-secondary);
        }
        .btn-secondary:hover {
            background: var(--border);
            color: var(--text-primary);
        }
        .btn-tertiary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--warning);
            font-size: 12px;
            padding: 6px 12px;
        }
        .btn-tertiary:hover {
            background: var(--border);
            color: white;
        }
        .btn-hidden {
            display: none;
        }
        
        /* Toastæç¤º */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 20px;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            z-index: 999;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.success { border-left: 4px solid var(--success); }
        
        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .card { padding: 20px; }
            .exif-grid { grid-template-columns: 1fr; }
            .preview-grid { grid-template-columns: 1fr; }
            .preview-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>RAW Insight</h1>
                <p class="subtitle">ä¸“ä¸šRAWæ ¼å¼å½±åƒè§£æå·¥å…· | æå–åµŒå…¥é¢„è§ˆå›¾ & æŸ¥çœ‹å®Œæ•´EXIFä¿¡æ¯<br>æ”¯æŒ: CR3/CR2/NEF/ARW/DNG/RAF/RW2/ORF/3FR/IIQ ç­‰æ ¼å¼</p>
            </div>
            
            <label class="upload-area" id="dropZone">
                <input type="file" id="rawFile" accept=".cr3,.cr2,.nef,.arw,.dng,.raf,.rw2,.orf,.3fr,.iiq,.pef,.sr2,.srw,.fff,.mef" onchange="handleFileSelect()">
                <div class="upload-icon">ğŸ“·</div>
                <div id="uploadText" class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤</div>
                <div class="upload-hint">æ”¯æŒæœ€å¤§200MBçš„RAWæ–‡ä»¶ | æ–‡ä»¶å°†åœ¨10åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†</div>
            </label>

            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <div style="color: var(--accent); font-size: 14px;">æ­£åœ¨æ·±åº¦è§£æå½±åƒæ•°æ®...</div>
            </div>

            <!-- EXIFä¿¡æ¯é¢æ¿ -->
            <div id="exifPanel" class="exif-panel">
                <!-- æ–‡ä»¶ä¿¡æ¯ -->
                <div class="exif-section">
                    <div class="exif-section-title">æ–‡ä»¶ä¿¡æ¯</div>
                    <div class="exif-grid">
                        <div class="exif-item">
                            <span class="exif-label">æ–‡ä»¶å</span>
                            <span id="fileName" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">æ–‡ä»¶å¤§å°</span>
                            <span id="fileSize" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">æ‹æ‘„æ—¶é—´</span>
                            <span id="shootTime" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">æ–‡ä»¶æ ¼å¼</span>
                            <span id="fileFormat" class="exif-value"></span>
                        </div>
                    </div>
                </div>
                
                <!-- ç›¸æœºä¿¡æ¯ -->
                <div class="exif-section">
                    <div class="exif-section-title">ç›¸æœºä¿¡æ¯</div>
                    <div class="exif-grid">
                        <div class="exif-item">
                            <span class="exif-label">ç›¸æœºå‹å·</span>
                            <span id="cameraModel" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">é•œå¤´å‹å·</span>
                            <span id="lensModel" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">ä¼ æ„Ÿå™¨å°ºå¯¸</span>
                            <span id="sensorSize" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">åˆ†è¾¨ç‡</span>
                            <span id="resolution" class="exif-value"></span>
                        </div>
                    </div>
                </div>
                
                <!-- æ›å…‰å‚æ•° -->
                <div class="exif-section">
                    <div class="exif-section-title">æ›å…‰å‚æ•°</div>
                    <div class="exif-grid">
                        <div class="exif-item">
                            <span class="exif-label">ISOæ„Ÿå…‰åº¦</span>
                            <span id="isoValue" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">å¿«é—¨é€Ÿåº¦</span>
                            <span id="shutterSpeed" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">å…‰åœˆ</span>
                            <span id="apertureValue" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">ç„¦è·</span>
                            <span id="focalLength" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">æ›å…‰è¡¥å¿</span>
                            <span id="exposureBias" class="exif-value"></span>
                        </div>
                        <div class="exif-item">
                            <span class="exif-label">ç™½å¹³è¡¡</span>
                            <span id="whiteBalance" class="exif-value"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é¢„è§ˆæå–é¢æ¿ -->
            <div id="previewPanel" class="preview-panel">
                <div class="preview-title">æ£€æµ‹åˆ°åµŒå…¥é¢„è§ˆå›¾ï¼ˆå…±<span id="previewCount">0</span>ä¸ªï¼‰</div>
                <div id="previewGrid" class="preview-grid"></div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="resetUpload()">å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div class="toast" id="toast"></div>

    <script>
        let currentFileId = '';
        let currentExt = '';
        let rawExifData = {};

        // å®šä¹‰Webå…¼å®¹æ ¼å¼åˆ—è¡¨
        const SUPPORTED_WEB_FORMATS = new Set(['JPEG', 'JPG', 'PNG', 'GIF', 'WebP', 'AVIF', 'SVG', 'BMP', 'ICO']);

        // åˆå§‹åŒ–æ‹–æ‹½
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        });

        // æ–‡ä»¶é€‰æ‹©
        function handleFileSelect() {
            const file = document.getElementById('rawFile').files[0];
            if (file) handleFile(file);
        }

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            // éªŒè¯å¤§å°
            const maxSize = 200 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('æ–‡ä»¶å¤§å°è¶…è¿‡200MBé™åˆ¶', 'error');
                return;
            }

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('uploadText').innerText = `å·²é€‰æ‹©: ${file.name} (${formatFileSize(file.size)})`;
            
            // ä¸Šä¼ è§£æ
            uploadFile(file);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // æ ¼å¼åŒ–å¿«é—¨é€Ÿåº¦ï¼ˆå°æ•°è½¬åˆ†æ•°ï¼‰
        function formatShutterSpeed(value) {
            if (value === 'æœªçŸ¥' || !value) return 'æœªçŸ¥';
            // è½¬æ¢ä¸ºåˆ†æ•°ï¼ˆå¦‚0.008 â†’ 1/125ï¼‰
            const num = parseFloat(value);
            if (num > 0 && num <= 1) {
                return `1/${Math.round(1/num)}`;
            }
            return value;
        }

        // æ ¼å¼åŒ–é•œå¤´å‹å·ï¼ˆæ•°å­—è½¬æ–‡å­—ï¼‰
        function formatLensModel(value) {
            if (typeof value === 'number') {
                // Canoné•œå¤´IDæ˜ å°„ï¼ˆè¡¥å……å¸¸ç”¨å€¼ï¼‰
                const lensMap = {
                    61182: 'Canon EF 24-70mm f/2.8L II USM',
                    59906: 'Canon EF 50mm f/1.4 USM',
                    61442: 'Canon RF 24-70mm f/2.8 L IS USM',
                    61698: 'Canon RF 50mm f/1.2 L USM'
                };
                return lensMap[value] || `æœªçŸ¥é•œå¤´ (ID: ${value})`;
            }
            return value || 'æœªçŸ¥';
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile(file) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('exifPanel').style.display = 'none';
            document.getElementById('previewPanel').style.display = 'none';

            const fd = new FormData();
            fd.append('file', file);

            try {
                const resp = await fetch('/upload', { method: 'POST', body: fd });
                if (!resp.ok) throw new Error(`HTTPé”™è¯¯: ${resp.status}`);
                
                const result = await resp.json();
                document.getElementById('loading').style.display = 'none';

                // æ ¸å¿ƒä¿®å¤ï¼šä¸¥æ ¼æ ¡éªŒè¿”å›ç»“æ„
                if (result.code !== 200 || !result.data) {
                    showToast(result.error || 'è§£æå¤±è´¥ï¼šè¿”å›æ•°æ®å¼‚å¸¸', 'error');
                    return;
                }

                const data = result.data;
                // ä¿å­˜å…¨å±€æ•°æ®
                currentFileId = data.file_id || '';
                currentExt = data.ext || '';
                rawExifData = data.raw_exif || {};

                // æ¸²æŸ“EXIFï¼ˆå¢åŠ é»˜è®¤å€¼ï¼‰
                renderExif(data.parsed_exif || {});
                
                // æ¸²æŸ“é¢„è§ˆå›¾
                renderPreviews(data.previews || []);
                
                showToast('æ–‡ä»¶è§£ææˆåŠŸï¼', 'success');

            } catch (e) {
                console.error('ä¸Šä¼ å¤±è´¥:', e);
                showToast('è§£æå¤±è´¥: ' + e.message, 'error');
                document.getElementById('loading').style.display = 'none';
            }
        }

        // æ¸²æŸ“EXIFä¿¡æ¯ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå¢åŠ æ‰€æœ‰å­—æ®µçš„é»˜è®¤å€¼ï¼‰
        function renderExif(exif) {
            document.getElementById('exifPanel').style.display = 'block';
            
            // æ–‡ä»¶ä¿¡æ¯ï¼ˆå¢åŠ é»˜è®¤å€¼ï¼‰
            document.getElementById('fileName').innerText = exif.fileName || 'æœªçŸ¥';
            document.getElementById('fileSize').innerText = exif.fileSize || 'æœªçŸ¥';
            document.getElementById('shootTime').innerText = exif.shootTime || 'æœªçŸ¥';
            document.getElementById('fileFormat').innerText = (exif.fileFormat || 'æœªçŸ¥').toUpperCase();
            
            // ç›¸æœºä¿¡æ¯ï¼ˆæ ¼å¼åŒ–+é»˜è®¤å€¼ï¼‰
            document.getElementById('cameraModel').innerText = exif.cameraModel || 'æœªçŸ¥';
            document.getElementById('lensModel').innerText = formatLensModel(exif.lensModel);
            document.getElementById('sensorSize').innerText = exif.sensorSize || 'æœªçŸ¥';
            
            // åˆ†è¾¨ç‡ï¼ˆé˜²undefinedï¼‰
            const width = exif.resolution?.width || 'æœªçŸ¥';
            const height = exif.resolution?.height || 'æœªçŸ¥';
            document.getElementById('resolution').innerText = `${width} Ã— ${height}`;
            
            // æ›å…‰å‚æ•°ï¼ˆæ ¼å¼åŒ–+é»˜è®¤å€¼ï¼‰
            document.getElementById('isoValue').innerText = exif.iso || 'æœªçŸ¥';
            document.getElementById('shutterSpeed').innerText = formatShutterSpeed(exif.shutterSpeed);
            document.getElementById('apertureValue').innerText = exif.aperture ? `f/${exif.aperture}` : 'æœªçŸ¥';
            document.getElementById('focalLength').innerText = exif.focalLength ? `${exif.focalLength} mm` : 'æœªçŸ¥';
            document.getElementById('exposureBias').innerText = exif.exposureBias || 'æœªçŸ¥';
            document.getElementById('whiteBalance').innerText = exif.whiteBalance || 'æœªçŸ¥';

            // ä»åŸå§‹EXIFè¡¥å……æ›´å¤šå­—æ®µï¼ˆå¢å¼ºå…¼å®¹æ€§ï¼‰
            if (rawExifData) {
                // è¡¥å……ISO
                if (exif.iso === 'æœªçŸ¥') {
                    const iso = rawExifData['MakerNotes:ISO'] || rawExifData['EXIF:ISO'] || 'æœªçŸ¥';
                    document.getElementById('isoValue').innerText = iso;
                }
                // è¡¥å……å¿«é—¨
                if (exif.shutterSpeed === 'æœªçŸ¥') {
                    const shutter = rawExifData['EXIF:ExposureTime'] || rawExifData['MakerNotes:ExposureTime'] || 'æœªçŸ¥';
                    document.getElementById('shutterSpeed').innerText = formatShutterSpeed(shutter);
                }
                // è¡¥å……å…‰åœˆ
                if (exif.aperture === 'æœªçŸ¥') {
                    const aperture = rawExifData['EXIF:FNumber'] || rawExifData['MakerNotes:Aperture'] || 'æœªçŸ¥';
                    document.getElementById('apertureValue').innerText = aperture ? `f/${aperture}` : 'æœªçŸ¥';
                }
            }
        }

        // æ¸²æŸ“é¢„è§ˆå›¾åˆ—è¡¨ï¼ˆæ–°å¢åŸå§‹æ ¼å¼ä¸‹è½½æŒ‰é’®ï¼‰
        function renderPreviews(previews) {
            document.getElementById('previewPanel').style.display = 'block';
            document.getElementById('previewCount').innerText = previews.length;
            
            const grid = document.getElementById('previewGrid');
            grid.innerHTML = '';

            if (previews.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:var(--text-secondary);">æœªæ£€æµ‹åˆ°å¯æå–çš„é¢„è§ˆå›¾</div>';
                return;
            }

            previews.forEach((preview, index) => {
                // è·³è¿‡æ— æ•ˆé¢„è§ˆå›¾
                if (!preview || !preview.tag || !currentFileId) return;
                
                // é¢„è§ˆå›¾ç±»å‹åç§°
                let previewType = getPreviewTypeName(preview.tag);
                // åˆ¤æ–­æ˜¯å¦ä¸ºWebå…¼å®¹æ ¼å¼
                const isWebFormat = SUPPORTED_WEB_FORMATS.has(preview.original_format || 'UNKNOWN');
                // åŸå§‹æ ¼å¼å’Œè½¬æ¢åæ ¼å¼
                const originalFormat = preview.original_format || 'æœªçŸ¥';
                const convertedFormat = preview.converted_format || 'JPEG';

                // åˆ›å»ºé¢„è§ˆå¡ç‰‡
                const card = document.createElement('div');
                card.className = 'preview-card';
                card.innerHTML = `
                    <div class="preview-img-container">
                        <div class="preview-loading" id="previewLoading${index}">åŠ è½½é¢„è§ˆä¸­...</div>
                        ${!isWebFormat ? `<div class="preview-format-tag">${originalFormat} â†’ ${convertedFormat}</div>` : ''}
                        <img id="previewImg${index}" class="preview-img" alt="${previewType}" 
                             onerror="handleImageError(${index})"
                             style="display:none;">
                    </div>
                    <div class="preview-info">
                        <div class="preview-name">${previewType} (${index+1})</div>
                        <div class="preview-meta">
                            åˆ†è¾¨ç‡: ${preview.resolution_str || 'æœªçŸ¥'}<br>
                            ${isWebFormat ? `å¤§å°: ${preview.size_str || 'æœªçŸ¥'}` : `è½¬æ¢åå¤§å°: ${preview.size_str || 'æœªçŸ¥'}<br>åŸå§‹å¤§å°: ${preview.raw_size_str || 'æœªçŸ¥'}`}<br>
                            æ ¼å¼: ${isWebFormat ? originalFormat : `${originalFormat}ï¼ˆå·²è½¬æ¢ä¸º${convertedFormat}ï¼‰`}
                        </div>
                        <div class="preview-actions">
                            <a class="btn" href="/extract/${currentFileId}/${currentExt}/${preview.tag}" 
                               download="${previewType}_${currentFileId.substring(0,8)}.${convertedFormat.toLowerCase()}">
                                ä¸‹è½½${convertedFormat}
                            </a>
                            <button class="btn btn-secondary" 
                                    onclick="openPreview('/extract/${currentFileId}/${currentExt}/${preview.tag}')">
                                æŸ¥çœ‹å¤§å›¾
                            </button>
                            <a class="btn btn-tertiary ${isWebFormat ? 'btn-hidden' : ''}" 
                               href="/extract_raw/${currentFileId}/${currentExt}/${preview.tag}"
                               download="${previewType}_${currentFileId.substring(0,8)}.${originalFormat.toLowerCase()}">
                                ä¸‹è½½åŸå§‹${originalFormat}
                            </a>
                        </div>
                    </div>
                `;
                grid.appendChild(card);

                // å»¶è¿ŸåŠ è½½é¢„è§ˆå›¾ï¼ˆé¿å…åŒæ—¶åŠ è½½è¿‡å¤šï¼‰
                setTimeout(() => {
                    const img = document.getElementById(`previewImg${index}`);
                    const loading = document.getElementById(`previewLoading${index}`);
                    if (!img || !loading) return;
                    
                    img.onload = function() {
                        loading.style.display = 'none';
                        img.style.display = 'block';
                    };
                    
                    // åŠ æ—¶é—´æˆ³é˜²ç¼“å­˜
                    img.src = `/extract/${currentFileId}/${currentExt}/${preview.tag}?t=${Date.now()}`;
                }, index * 300); // æ¯éš”300msåŠ è½½ä¸€ä¸ª
            });
        }

        // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
        function handleImageError(index) {
            const img = document.getElementById(`previewImg${index}`);
            const loading = document.getElementById(`previewLoading${index}`);
            if (img && loading) {
                loading.style.display = 'none';
                img.parentElement.innerHTML = `<div class=preview-error>é¢„è§ˆå›¾åŠ è½½å¤±è´¥<br>å¯å°è¯•ä¸‹è½½åŸå§‹æ–‡ä»¶</div>`;
            }
        }

        // è·å–é¢„è§ˆå›¾ç±»å‹åç§°
        function getPreviewTypeName(tag) {
            if (!tag) return 'é¢„è§ˆå›¾';
            if (tag.includes('Thumbnail')) return 'ç¼©ç•¥å›¾';
            if (tag.includes('LargePreview')) return 'é«˜æ¸…é¢„è§ˆå›¾';
            if (tag.includes('Preview')) return 'æ ‡å‡†é¢„è§ˆå›¾';
            if (tag.includes('Embedded')) return 'åµŒå…¥å¼é¢„è§ˆå›¾';
            if (tag.includes('JpgFromRaw')) return 'åŸå§‹JPGå›¾';
            return 'é¢„è§ˆå›¾';
        }

        // æ‰“å¼€å¤§å›¾é¢„è§ˆ
        function openPreview(url) {
            if (!url) {
                showToast('é¢„è§ˆå›¾åœ°å€æ— æ•ˆ', 'error');
                return;
            }
            const win = window.open('', '_blank');
            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>é¢„è§ˆå›¾</title>
                    <style>
                        body { margin:0; background:#000; display:flex; align-items:center; justify-content:center; min-height:100vh; }
                        img { max-width:95%; max-height:95vh; object-fit:contain; }
                        .error { color:white; text-align:center; padding:20px; }
                    </style>
                </head>
                <body>
                    <img src="${url}?t=${Date.now()}" alt="é¢„è§ˆå›¾" onerror="this.parentNode.innerHTML='<div class=error>é¢„è§ˆå›¾åŠ è½½å¤±è´¥</div>'">
                </body>
                </html>
            `);
            win.document.close();
        }

        // é‡ç½®ä¸Šä¼ çŠ¶æ€
        function resetUpload() {
            document.getElementById('rawFile').value = '';
            document.getElementById('uploadText').innerText = 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤';
            document.getElementById('exifPanel').style.display = 'none';
            document.getElementById('previewPanel').style.display = 'none';
            currentFileId = '';
            currentExt = '';
            rawExifData = {};
        }

        // Toastæç¤º
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message || 'æ“ä½œæç¤º';
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>